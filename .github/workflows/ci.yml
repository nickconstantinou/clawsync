name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ShellCheck
        run: |
          # Install shellcheck
          apt-get update && apt-get install -y shellcheck
          # Lint scripts
          shellcheck sync.sh restore.sh || true

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up test workspace
        run: |
          mkdir -p /tmp/test-workspace
          echo "# Test Identity" > /tmp/test-workspace/TEST.md
          echo "test content" > /tmp/test-workspace/AGENTS.md
          mkdir -p /tmp/test-workspace/skills
          mkdir -p /tmp/test-workspace/scripts
          echo "echo test" > /tmp/test-workspace/scripts/test.sh
          chmod +x /tmp/test-workspace/scripts/test.sh
      
      - name: Set environment
        run: |
          echo "BACKUP_REPO=test/repo" >> $GITHUB_ENV
          echo "OPENCLAW_WORKSPACE=/tmp/test-workspace" >> $GITHUB_ENV
          echo "GITHUB_TOKEN=dummy" >> $GITHUB_ENV
      
      - name: Run sync.sh in temp dir (simulates backup repo)
        run: |
          # Create a fresh dir to act as backup repo
          cd /tmp
          rm -rf backup-repo-test
          mkdir backup-repo-test
          cd backup-repo-test
          git init
          git config --global user.email "test@test.com"
          git config --global user.name "Test"
          # Copy sync.sh here
          cp ${{ github.workspace }}/sync.sh .
          cp ${{ github.workspace }}/restore.sh .
          # Run it
          bash sync.sh || echo "Push failed (expected - dummy token)"
      
      - name: Verify files copied to backup repo
        run: |
          cd /tmp/backup-repo-test
          [ -f TEST.md ] || { echo "TEST.md not copied"; exit 1; }
          [ -f AGENTS.md ] || { echo "AGENTS.md not copied"; exit 1; }
          [ -d skills ] || { echo "skills not copied"; exit 1; }
          [ -f scripts/test.sh ] || { echo "script not copied"; exit 1; }
          echo "âœ… Integration test passed"

  publish:
    needs: [lint, test]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Publish to ClawHub
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        run: |
          npm install -g clawhub
          clawhub login --token "$CLAWHUB_TOKEN" --no-browser
          VERSION=${GITHUB_REF#refs/tags/v}
          clawhub publish . --version $VERSION
